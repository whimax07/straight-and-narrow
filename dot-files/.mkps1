#!/bin/bash

# MKPS1
# (Mike Kasberg PS1)
# (Or, Make PS1)
# Copied and modified from https://github.com/mkasberg/dotfiles/tree/master.

# Different functions generate different parts (segments) of the PS1 prompt.
# Each function should leave the colors in a clean state (e.g. call reset if they changed any colors).

# For Git PS1
source /usr/share/git-core/contrib/completion/git-prompt.sh;
GIT_PS1_SHOWDIRTYSTATE=1
GIT_PS1_SHOWUPSTREAM="verbose"

__mkps1_debian_chroot() {
    # This string is intentionally single-quoted:
    # It will be evaluated when $PS1 is evaluated to generate the prompt each time.
    echo '${debian_chroot:+($debian_chroot)}';
}

__mkps1_inject_exitcode() {
    local code=$1

    if [ "$code" -ne "0" ]; then
        echo " $code "
    fi
}

__mkps1_exitcode() {
    local bg_red=`tput setab 1`;
    local white=`tput setaf 15`;
    local reset=`tput sgr0`;

    # We need to run a function at runtime to evaluate the exitcode.
    echo "\[${bg_red}\]\[${white}\]\$(__mkps1_inject_exitcode \$?)\[${reset}\]"
}

__mkps1_time() {
    local BG_GRAY=`tput setab 240`;
    local white=`tput setaf 7`;
    local reset=`tput sgr0`;

    echo "\[${BG_GRAY}\]\[${white}\]\t\[${reset}\]"
}

__mkps1_username() {
    local cyan=`tput setaf 45`;
    local reset=`tput sgr0`;

    echo "\[${cyan}\]\u\[${reset}\]";
}

__mkps1_arrows() {
    local bold=`tput bold`;
    local red=`tput setaf 1`;
    local green=`tput setaf 34`;
    local reset=`tput sgr0`;

    echo "\[${bold}${red}\]>>\[${green}\]>\[${reset}\]";
}

__mkps1_workdir() {
    local bold=`tput bold`;
    local cyan=`tput setaf 45`;
    local reset=`tput sgr0`;

    echo "\[${bold}${cyan}\]\w\[${reset}\]";
}

__mkps1_git() {
    local magenta=`tput setaf 213`;
    local reset=`tput sgr0`;

    # Escaping the $ is intentional:
    # This is evaluated when the prompt is generated.
    echo "\$(__git_ps1 ' (\[${magenta}\]%s\[${reset}\])')"
}

__mkps1_box_top() {
    local cyan=`tput setaf 45`;
    local reset=`tput sgr0`;
    echo "\[${cyan}\]╭\[${reset}\]"
}

__mkps1_box_bottom() {
    local cyan=`tput setaf 45`;
    local reset=`tput sgr0`;
    echo "\[${cyan}\]╰\[${reset}\]"
}


__mkps1_user_prompt() {
    local bold=`tput bold`;
    local reset=`tput sgr0`;
    
    echo "\[${bold}\]\$\[${reset}\] ";
}

__mkps1_calculate_time_taken() {
    if [[ ! -e "$PS_TIME_RECORD" ]]; then return; fi

    local start_time
    start_time=$(cat "$PS_TIME_RECORD")

    rm -f "$PS_TIME_RECORD"
    if ((start_time == 0)); then return; fi

    local end_time
    end_time=$(date +%s)

    local duration
    duration=$((end_time - start_time))
    if ((duration == 0)); then return; fi
    echo " e$duration"
}

__mkps1_show_time_taken() {
    local BG_GRAY=`tput setab 240`;
    local white=`tput setaf 7`;
    local reset=`tput sgr0`;

    echo "\[${BG_GRAY}\]\[${white}\]\$(__mkps1_calculate_time_taken)\[${reset}\]"
}

__mkps1() {
	local newLine="\012"
    local ps1="${newLine}$(__mkps1_box_top)$(__mkps1_debian_chroot)$(__mkps1_exitcode)$(__mkps1_time)$(__mkps1_show_time_taken) $(__mkps1_username) $(__mkps1_arrows) $(__mkps1_workdir)$(__mkps1_git)${newLine}$(__mkps1_box_bottom)$(__mkps1_user_prompt)";

    echo "$ps1";
}



# shellcheck disable=SC2120
__mkps1_set_start_time() {
    date +%s > "$PS_TIME_RECORD"
}

__mkps0() {
    echo "\$(__mkps1_set_start_time)"
}



# To test, for example, print output before changes and after changes
# and see if the diff is correct.
# Uncomment for testing:
#__mkps1;
